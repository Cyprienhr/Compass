<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if record %}Edit Payroll{% else %}Create Payroll{% endif %}</title>
  <link rel="stylesheet" href="/static/css/dashboard.css">
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const select = document.querySelector('select[name="employee"]');
      const info = document.getElementById('emp-info');
      const amountField = document.querySelector('input[name="amount"]');
      const deductedField = document.querySelector('input[name="deducted"]');
      const bonusField = document.querySelector('input[name="bonus"]');
      const dateField = document.querySelector('input[name="date"]');
      const categoryField = document.querySelector('select[name="category"]');
      const form = document.querySelector('form');
      const isEditing = form.dataset.editing === 'true';
      
      function load() {
        const id = select.value;
        if (!id) { 
          info.textContent = 'Pick an employee to preview details.'; 
          return; 
        }
        
        // Load employee info
        fetch('/employees/' + id + '/json/')
          .then(r => r.ok ? r.json() : null)
          .then(data => {
            if (!data) { info.textContent = 'Unable to load.'; return; }
            info.innerHTML = `
              <div><strong>Name:</strong> ${data.full_name}</div>
              <div><strong>National ID:</strong> ${data.national_id}</div>
              <div><strong>Category:</strong> ${data.category}</div>
              <div><strong>Site:</strong> ${data.site}</div>
              <div><strong>Contact:</strong> ${data.contact || '-'}</div>
              <div><strong>Status:</strong> ${data.is_active ? 'Active' : 'Inactive'}</div>
            `;
          }).catch(() => info.textContent = 'Unable to load.');
        
        // Load latest attendance data and auto-fill payroll form
        fetch('/attendance/' + id + '/latest/json/')
          .then(r => r.ok ? r.json() : null)
          .then(attendanceData => {
            if (attendanceData && !attendanceData.error) {
              if (!isEditing) {
                // Auto-fill the form fields with attendance data when creating new record
                if (amountField) amountField.value = attendanceData.total_amount;
                if (deductedField) deductedField.value = attendanceData.deducted;
                if (bonusField) bonusField.value = attendanceData.bonus;
                if (dateField) dateField.value = attendanceData.date;
                
                // Set category if it matches
                if (categoryField && attendanceData.category_id) {
                  for (let option of categoryField.options) {
                    if (option.value == attendanceData.category_id) {
                      option.selected = true;
                      break;
                    }
                  }
                }
                
                // Show success message
                info.innerHTML += '<div style="color: green; margin-top: 10px;"><strong>✓ Attendance data auto-filled!</strong></div>';
            } else {
                // Show attendance info but don't auto-fill when editing
                info.innerHTML += '<div style="color: blue; margin-top: 10px;"><strong>ℹ Latest attendance: ' + attendanceData.total_amount + ' (' + attendanceData.period_type + ' x' + attendanceData.periods_worked + ')</strong></div>';
              }
            }
          }).catch(() => {
            // Silently fail if attendance data can't be loaded
            console.log('Could not load attendance data');
          });
      }
      
      select.addEventListener('change', load);
      load();
    });
  </script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <a class="nav-link" href="/payroll/">Back to Payroll</a>
    </aside>
    <main class="content">
      <h1>{% if record %}Edit Payroll{% else %}Create Payroll{% endif %}</h1>
      <form method="post" action="" data-editing="{% if record %}true{% else %}false{% endif %}">
        {% csrf_token %}
        <div class="grid-2">
          <label>Employee
            <select name="employee" required>
              {% for e in employees %}
                <option value="{{ e.id }}" {% if record.employee_id == e.id %}selected{% endif %}>{{ e.full_name }} ({{ e.national_id }})</option>
              {% endfor %}
            </select>
          </label>
          <div class="card" style="grid-column:1/-1">
            <strong>Selected employee info</strong>
            <div id="emp-info" class="muted">Pick an employee to preview details.</div>
          </div>
          <label>Category
            <select name="category" required>
              {% for c in categories %}
                <option value="{{ c.id }}" {% if record.category_id == c.id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label>Amount<input name="amount" type="number" step="0.01" value="{{ record.amount }}" required></label>
          <label>Deducted<input name="deducted" type="number" step="0.01" value="{{ record.deducted|default:0 }}"></label>
          <label>Bonus<input name="bonus" type="number" step="0.01" value="{{ record.bonus|default:0 }}"></label>
          <label>Date<input name="date" type="date" value="{{ record.date|date:'Y-m-d' }}"></label>
          <label>Payment Status
            <select name="payment_status" required>
              <option value="PENDING" {% if record.payment_status == 'PENDING' or not record %}selected{% endif %}>Pending</option>
              <option value="PAID" {% if record.payment_status == 'PAID' %}selected{% endif %}>Paid</option>
              <option value="PARTIAL" {% if record.payment_status == 'PARTIAL' %}selected{% endif %}>Partial</option>
            </select>
          </label>
          <label>Signature<input name="signature" type="checkbox" value="true" {% if record.signature %}checked{% endif %}></label>
        </div>
        <button type="submit">Save</button>
      </form>
    </main>
  </div>
</body>
</html>


